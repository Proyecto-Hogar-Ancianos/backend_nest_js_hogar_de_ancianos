pipeline {
    agent any

    stages {
        stage('Test JMeter Only') {
            steps {
                script {
                    echo '[PIPELINE] Iniciando prueba de JMeter...'
                    
                    def jmeterRunner = load("${WORKSPACE}/jenkins/tony/scripts/jmeter-runner.groovy")
                    
                    echo '[PIPELINE] Ejecutando runJMeterTests()...'
                    jmeterRunner.runJMeterTests()
                    
                    echo '[PIPELINE] Obteniendo resultados...'
                    def results = jmeterRunner.getJMeterResults()
                    
                    echo '[PIPELINE] Resultados:'
                    echo results
                }
            }
        }
    }

    post {
        always {
            script {
                echo '[PIPELINE] Verificando archivos generados...'
                bat '''
                    @echo off
                    echo.
                    echo === Contenido del directorio jenkins/tony/jmeter-results ===
                    if exist "jenkins\tony\jmeter-results" (
                        dir jenkins\tony\jmeter-results
                    ) else (
                        echo Directorio jenkins/tony/jmeter-results NO existe
                    )
                    
                    echo.
                    echo === Verificando resultado del where jmeter ===
                    where jmeter
                    if errorlevel 1 (
                        echo JMeter NO encontrado en PATH
                    ) else (
                        echo JMeter encontrado en PATH
                    )
                    
                    echo.
                    echo === PATH actual ===
                    echo %PATH%
                '''
            }
        }
    }
}
