pipeline {
    agent any

    triggers {
            // Esto NO funcionará mientras Jenkins sea local.
        gitlab(triggerOnPush: true, triggerOnMergeRequest: true, branchFilterType: 'NameBasedFilter', includeBranchesSpec: 'dev', excludeBranchesSpec: '')
            // La unica opcion que encontre xd
            //ejecutarlo cada minuto
       // pollSCM('* * * * *')
        //ejecutarlo a las 12 am
        pollSCM('0 0 * * *')
    }

    options {
        timestamps()
        timeout(time: 30, unit: 'MINUTES')
        buildDiscarder(logRotator(numToKeepStr: '10'))
    }

    environment {
        SOURCE_REPO = 'https://git.ucr.ac.cr/proyecto_analisis/backend_nest_js_hogar_de_ancianos'
        SOURCE_BRANCH = 'dev'
        TARGET_REPO = 'https://git.ucr.ac.cr/proyecto_analisis/test_backend_nest_js_hogar_de_ancianos'
        TARGET_BRANCH = 'dev'
        EMAIL_RECIPIENT = 'antonyml2016@gmail.com'
        WORKSPACE_DIR = "${WORKSPACE}"
    }

    stages {
        stage('Checkout') {
            steps {
                script {
                    checkout(
                        [
                            $class: 'GitSCM',
                            branches: [[name: "*/${SOURCE_BRANCH}"]],
                            userRemoteConfigs: [[url: "${SOURCE_REPO}"]]
                        ]
                    )
                }
            }
        }

        stage('Initialize') {
            steps {
                script {
                    
                    bat '''
                        @echo off
                        git rev-parse HEAD > current_commit.txt
                    '''
                    
                    def currentCommit = readFile('current_commit.txt').trim()
                    def lastBuildFile = "${WORKSPACE}/.last_commit"
                    def lastCommit = ''
                    
                    if (fileExists(lastBuildFile)) {
                        lastCommit = readFile(lastBuildFile).trim()
                    }
                    
                    env.CURRENT_COMMIT = currentCommit
                    env.LAST_COMMIT = lastCommit
                    
                    echo "Current: ${currentCommit}"
                    echo "Last: ${lastCommit}"
                    
                    if (currentCommit != lastCommit) {
                        env.HAS_CHANGES = 'true'
                        writeFile file: lastBuildFile, text: currentCommit
                        echo "✓ Changes detected!"
                    } else {
                        env.HAS_CHANGES = 'false'
                        echo "✗ No changes. Stopping pipeline."
                    }
                }
            }
        }

        stage('Checkout Source') {
            when {
                expression { env.HAS_CHANGES == 'true' }
            }
            steps {
                script {
                    echo "Repository already checked out, skipping duplicate checkout"
                }
            }
        }

        stage('Push to Test Repository') {
            when {
                expression { env.HAS_CHANGES == 'true' }
            }
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: 'git-credentials', usernameVariable: 'GIT_USER', passwordVariable: 'GIT_PASS')]) {
                        bat '''
                            @echo off
                            setlocal enabledelayedexpansion
                            
                            REM URL-encode the password: @ = %%40, ? = %%3F
                            setlocal enabledelayedexpansion
                            set "PASS_ENCODED=!GIT_PASS:@=%%40!"
                            set "PASS_ENCODED=!PASS_ENCODED:?=%%3F!"
                            set "URL_WITH_CREDS=https://%GIT_USER%:!PASS_ENCODED!@git.ucr.ac.cr/proyecto_analisis/test_backend_nest_js_hogar_de_ancianos.git"
                            
                            REM Add remote with credentials in URL
                            git remote add test-repo "!URL_WITH_CREDS!" 2>nul
                            if errorlevel 1 (
                                REM Remote might already exist, remove and add again
                                git remote remove test-repo 2>nul
                                git remote add test-repo "!URL_WITH_CREDS!"
                            )
                            
                            REM Push with verbose output
                            git push -u test-repo HEAD:%TARGET_BRANCH% --force
                        '''
                    }
                }
            }
        }

        stage('Install Dependencies') {
            when {
                expression { env.HAS_CHANGES == 'true' }
            }
            steps {
                script {
                    bat 'npm install'
                }
            }
        }

        stage('Run Jest Tests') {
            when {
                expression { env.HAS_CHANGES == 'true' }
            }
            steps {
                script {
                    bat 'npm run test -- --coverage --testPathPatterns="tests/tony/unit" > jest-results.log 2>&1'
                }
            }
        }

        stage('Run Unit Tests - Users Service') {
            when {
                expression { env.HAS_CHANGES == 'true' }
            }
            steps {
                script {
                    bat 'npm run test -- tests/tony/unit/users/user.service.spec.ts --verbose > unit-test-results.log 2>&1'
                }
            }
        }

        stage('Push to Deploy Repository') {
            when {
                expression { env.HAS_CHANGES == 'true' && currentBuild.result == null }
            }
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: 'git-credentials', usernameVariable: 'GIT_USER', passwordVariable: 'GIT_PASS')]) {
                        bat '''
                            @echo off
                            setlocal enabledelayedexpansion
                            
                            REM URL-encode the password: @ = %%40, ? = %%3F
                            setlocal enabledelayedexpansion
                            set "PASS_ENCODED=!GIT_PASS:@=%%40!"
                            set "PASS_ENCODED=!PASS_ENCODED:?=%%3F!"
                            set "URL_WITH_CREDS=https://%GIT_USER%:!PASS_ENCODED!@git.ucr.ac.cr/proyecto_analisis/deploy_backend_nest_js_hogar_de_ancianos.git"
                            
                            REM Add remote with credentials in URL
                            git remote add deploy-repo "!URL_WITH_CREDS!" 2>nul
                            if errorlevel 1 (
                                REM Remote might already exist, remove and add again
                                git remote remove deploy-repo 2>nul
                                git remote add deploy-repo "!URL_WITH_CREDS!"
                            )
                            
                            REM Push to master branch with verbose output
                            git push -u deploy-repo HEAD:master --force
                            
                            echo ✓ Deployed successfully to master branch in deploy repository
                        '''
                    }
                }
            }
        }
    }

    post {
        always {
            script {
                if (env.HAS_CHANGES == 'false') {
                    currentBuild.result = 'NOT_BUILT'
                    echo "Build marked as NOT_BUILT - no changes detected"
                }
                
                if (fileExists('jest-results.log')) {
                    junit testResults: '**/test-results/**/*.xml', allowEmptyResults: true
                }
            }
        }

        success {
            script {
                if (env.HAS_CHANGES == 'true') {
                    def testOutput = ''
                    def unitTestOutput = ''
                    
                    if (fileExists('jest-results.log')) {
                        testOutput = readFile('jest-results.log').take(500)
                    }
                    if (fileExists('unit-test-results.log')) {
                        unitTestOutput = readFile('unit-test-results.log').take(500)
                    }
                    
                    emailext(
                        to: "${EMAIL_RECIPIENT}",
                        subject: "Jenkins Pipeline - Rama ${SOURCE_BRANCH}: BUILD EXITOSO",
                        body: """
                            <html>
                                <body>
                                    <h2>Pipeline Build - EXITOSO</h2>
                                    <p><strong>Repositorio:</strong> ${SOURCE_REPO}</p>
                                    <p><strong>Rama:</strong> ${SOURCE_BRANCH}</p>
                                    <p><strong>Build Number:</strong> ${BUILD_NUMBER}</p>
                                    <p><strong>Build URL:</strong> <a href="${BUILD_URL}">${BUILD_URL}</a></p>
                                    
                                    <h3>Resumen de Ejecución:</h3>
                                    <ul>
                                        <li>Código descargado exitosamente</li>
                                        <li>Push al repositorio de pruebas completado</li>
                                        <li>Dependencias instaladas</li>
                                        <li>Jest Tests ejecutados exitosamente</li>
                                        <li>Unit Tests de Users Service ejecutados exitosamente</li>
                                        <li>✓ Desplegado al repositorio de deploy</li>
                                    </ul>

                                    <h3>Detalles de los Tests:</h3>
                                    <pre>${testOutput}</pre>
                                    
                                    <h3>Detalles Unit Tests - Users Service:</h3>
                                    <pre>${unitTestOutput}</pre>

                                    <hr>
                                    <p><strong>Build ID:</strong> ${BUILD_NUMBER}</p>
                                    <p><em>Este es un mensaje automático del sistema CI/CD</em></p>
                                </body>
                            </html>
                        """,
                        mimeType: 'text/html'
                    )
                    
                    env.BUILD_SUCCESS = 'true'
                }
            }
        }

        failure {
            script {
                if (env.HAS_CHANGES == 'true') {
                    def testOutput = ''
                    def unitTestOutput = ''
                    
                    if (fileExists('jest-results.log')) {
                        testOutput = readFile('jest-results.log').take(1000)
                    }
                    if (fileExists('unit-test-results.log')) {
                        unitTestOutput = readFile('unit-test-results.log').take(1000)
                    }
                    
                    emailext(
                        to: "${EMAIL_RECIPIENT}",
                        subject: "Jenkins Pipeline - Rama ${SOURCE_BRANCH}: BUILD FALLIDO",
                        body: """
                            <html>
                                <body>
                                    <h2>Pipeline Build - FALLIDO</h2>
                                    <p><strong>Repositorio:</strong> ${SOURCE_REPO}</p>
                                    <p><strong>Rama:</strong> ${SOURCE_BRANCH}</p>
                                    <p><strong>Build Number:</strong> ${BUILD_NUMBER}</p>
                                    <p><strong>Build URL:</strong> <a href="${BUILD_URL}">${BUILD_URL}</a></p>
                                    
                                    <h3>Causa del Fallo:</h3>
                                    <p>Revisa los logs detallados a continuación para identificar el problema.</p>

                                    <h3>Salida de Jest Tests:</h3>
                                    <pre>${testOutput}</pre>
                                    
                                    <h3>Salida Unit Tests - Users Service:</h3>
                                    <pre>${unitTestOutput}</pre>

                                    <h3>Acciones Recomendadas:</h3>
                                    <ol>
                                        <li>Revisa los logs completos en: <a href="${BUILD_URL}console">${BUILD_URL}console</a></li>
                                        <li>Verifica los cambios en la rama ${SOURCE_BRANCH}</li>
                                        <li>Ejecuta localmente: npm run test</li>
                                        <li>Contacta al equipo de desarrollo si es necesario</li>
                                    </ol>

                                    <hr>
                                    <p><strong>Build ID:</strong> ${BUILD_NUMBER}</p>
                                    <p><em>Este es un mensaje automático del sistema CI/CD</em></p>
                                </body>
                            </html>
                        """,
                        mimeType: 'text/html'
                    )
                }
            }
        }

        unstable {
            script {
                if (env.HAS_CHANGES == 'true') {
                    emailext(
                        to: "${EMAIL_RECIPIENT}",
                        subject: "Jenkins Pipeline - Rama ${SOURCE_BRANCH}: BUILD INESTABLE",
                        body: """
                            <html>
                                <body>
                                    <h2>Pipeline Build - INESTABLE</h2>
                                    <p><strong>Repositorio:</strong> ${SOURCE_REPO}</p>
                                    <p><strong>Rama:</strong> ${SOURCE_BRANCH}</p>
                                    <p><strong>Build Number:</strong> ${BUILD_NUMBER}</p>
                                    <p><strong>Build URL:</strong> <a href="${BUILD_URL}">${BUILD_URL}</a></p>
                                    
                                    <p>El pipeline completó pero hay algunos tests que fallaron o produjeron advertencias.</p>
                                    <p>Por favor revisa los detalles en: <a href="${BUILD_URL}console">${BUILD_URL}console</a></p>

                                    <hr>
                                    <p><em>Este es un mensaje automático del sistema CI/CD</em></p>
                                </body>
                            </html>
                        """,
                        mimeType: 'text/html'
                    )
                }
            }
        }
    }
}