pipeline {
    agent any
    
    options {
        timestamps()
        buildDiscarder(logRotator(numToKeepStr: '10'))
    }
    
    stages {
        stage('Build Application') {
            steps {
                script {
                    echo '=== Building NestJS Application ==='
                    bat '''
                        cd %WORKSPACE%
                        call npm run build
                    '''
                }
            }
        }
        
        stage('Deploy via FTP') {
            steps {
                script {
                    echo '=== Deploying to FTP Server ==='
                    powershell '''
                        $ErrorActionPreference = "Stop"
                        
                        # Configuración FTP
                        $FtpServer = "localhost"
                        $FtpPort = 21
                        $FtpUser = "ftpadmin"
                        $FtpPassword = "Ftp@2025Proyecto"
                        $SourcePath = "${env:WORKSPACE}\\dist"
                        $ProductionPath = "C:\\ProyectoAnalisis\\backend\\www"
                        $ZipPath = "${env:WORKSPACE}\\dist.zip"
                        $RemotePath = "/backend/www"
                        
                        try {
                            # 1. Crear ZIP
                            Write-Host "Step 1: Creando ZIP..." -ForegroundColor Green
                            if (Test-Path $ZipPath) {
                                Remove-Item $ZipPath -Force
                            }
                            [System.IO.Compression.ZipFile]::CreateFromDirectory($SourcePath, $ZipPath, "Optimal", $false)
                            $ZipSize = (Get-Item $ZipPath).Length / 1MB
                            Write-Host "ZIP creado: $($ZipSize)MB" -ForegroundColor Green
                            
                            # 2. Conectar a FTP
                            Write-Host "Step 2: Conectando a FTP..." -ForegroundColor Green
                            $FtpUri = "ftp://${FtpServer}:${FtpPort}${RemotePath}/"
                            $Credential = New-Object System.Net.NetworkCredential($FtpUser, $FtpPassword)
                            
                            # 3. Subir archivo
                            Write-Host "Step 3: Subiendo archivo ZIP a FTP..." -ForegroundColor Green
                            $FtpRequest = [System.Net.FtpWebRequest]::Create("${FtpUri}dist.zip")
                            $FtpRequest.Method = [System.Net.WebRequestMethods+Ftp]::UploadFile
                            $FtpRequest.Credentials = $Credential
                            $FtpRequest.UseBinary = $true
                            $FtpRequest.KeepAlive = $false
                            
                            $FileStream = [System.IO.File]::OpenRead($ZipPath)
                            $UploadStream = $FtpRequest.GetRequestStream()
                            $FileStream.CopyTo($UploadStream)
                            $UploadStream.Close()
                            $FileStream.Close()
                            
                            $FtpResponse = $FtpRequest.GetResponse()
                            Write-Host "FTP Upload Response: $($FtpResponse.StatusDescription)" -ForegroundColor Green
                            $FtpResponse.Close()
                            
                            # 4. Extraer ZIP en producción
                            Write-Host "Step 4: Extrayendo ZIP en producción..." -ForegroundColor Green
                            if (Test-Path "${ProductionPath}\\dist.zip") {
                                [System.IO.Compression.ZipFile]::ExtractToDirectory("${ProductionPath}\\dist.zip", $ProductionPath, $true)
                                Write-Host "ZIP extraído correctamente" -ForegroundColor Green
                            } else {
                                Write-Host "ERROR: ZIP no encontrado en ${ProductionPath}" -ForegroundColor Red
                                exit 1
                            }
                            
                            # 5. Limpiar
                            Write-Host "Step 5: Limpiando archivos temporales..." -ForegroundColor Green
                            Remove-Item $ZipPath -Force
                            if (Test-Path "${ProductionPath}\\dist.zip") {
                                Remove-Item "${ProductionPath}\\dist.zip" -Force
                            }
                            
                            Write-Host "Despliegue FTP completado exitosamente" -ForegroundColor Green
                            
                        } catch {
                            Write-Host "ERROR: $_" -ForegroundColor Red
                            exit 1
                        }
                    '''
                }
            }
        }
        
        stage('Verify Deployment') {
            steps {
                script {
                    echo '=== Verificando despliegue ==='
                    powershell '''
                        $ProductionPath = "C:\\ProyectoAnalisis\\backend\\www"
                        
                        if (Test-Path "${ProductionPath}\\dist") {
                            $FileCount = (Get-ChildItem "${ProductionPath}\\dist" -Recurse).Count
                            Write-Host "Archivos en dist: $FileCount" -ForegroundColor Green
                        } else {
                            Write-Host "ERROR: Carpeta dist no existe" -ForegroundColor Red
                            exit 1
                        }
                    '''
                }
            }
        }
    }
    
    post {
        always {
            cleanWs()
        }
        success {
            echo '✅ Pipeline ejecutado exitosamente'
        }
        failure {
            echo '❌ Pipeline falló'
        }
    }
}
