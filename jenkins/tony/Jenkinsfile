pipeline {
    agent any

    triggers {
        gitlab(triggerOnPush: true, triggerOnMergeRequest: true, branchFilterType: 'NameBasedFilter', includeBranchesSpec: 'dev', excludeBranchesSpec: '')
        pollSCM('0 0 * * *')
    }

    options {
        timestamps()
        timeout(time: 30, unit: 'MINUTES')
        buildDiscarder(logRotator(numToKeepStr: '10'))
    }

    environment {
        WORKSPACE_DIR = "${WORKSPACE}"
    }

    stages {
        stage('Load Configuration') {
            steps {
                script {
                    def config = load("${WORKSPACE}/jenkins/tony/scripts/config.groovy")
                    
                    env.SOURCE_REPO = config.getSourceRepo()
                    env.SOURCE_BRANCH = config.getSourceBranch()
                    env.TARGET_REPO = config.getTestRepo()
                    env.TARGET_BRANCH = config.getTestBranch()
                    env.DEPLOY_REPO = config.getDeployRepo()
                    env.DEPLOY_BRANCH = config.getDeployBranch()
                    env.EMAIL_RECIPIENT = config.getEmailRecipient()
                }
            }
        }

        stage('Initialize & Check Changes') {
            steps {
                script {
                    def gitOps = load("${WORKSPACE}/jenkins/tony/scripts/git-operations.groovy")
                    
                    gitOps.checkoutSource(env.SOURCE_REPO, env.SOURCE_BRANCH)
                    
                    def currentCommit = gitOps.getCurrentCommit()
                    def lastCommit = gitOps.getLastCommit(env.WORKSPACE)
                    
                    env.CURRENT_COMMIT = currentCommit
                    env.LAST_COMMIT = lastCommit
                    
                    if (gitOps.hasChanges(currentCommit, lastCommit)) {
                        env.HAS_CHANGES = 'true'
                        gitOps.saveCurrentCommit(env.WORKSPACE, currentCommit)
                    } else {
                        env.HAS_CHANGES = 'false'
                        currentBuild.result = 'NOT_BUILT'
                    }
                }
            }
        }

        stage('Push to Test Repository') {
            when {
                expression { env.HAS_CHANGES == 'true' }
            }
            steps {
                script {
                    def gitOps = load("${WORKSPACE}/jenkins/tony/scripts/git-operations.groovy")
                    gitOps.pushToRepository(env.TARGET_REPO, env.TARGET_BRANCH, 'git-credentials')
                }
            }
        }

        stage('Install Dependencies') {
            when {
                expression { env.HAS_CHANGES == 'true' }
            }
            steps {
                script {
                    def testRunner = load("${WORKSPACE}/jenkins/tony/scripts/test-runner.groovy")
                    testRunner.installDependencies()
                }
            }
        }

        stage('Run Tests') {
            when {
                expression { env.HAS_CHANGES == 'true' }
            }
            steps {
                script {
                    def testRunner = load("${WORKSPACE}/jenkins/tony/scripts/test-runner.groovy")
                    
                    try {
                        testRunner.runJestTests()
                        testRunner.runUnitTests()
                        testRunner.publishTestResults()
                    } catch (Exception e) {
                        currentBuild.result = 'FAILURE'
                        throw e
                    }
                }
            }
        }

        stage('Push to Deploy Repository') {
            when {
                expression { env.HAS_CHANGES == 'true' && currentBuild.result == null }
            }
            steps {
                script {
                    def gitOps = load("${WORKSPACE}/jenkins/tony/scripts/git-operations.groovy")
                    gitOps.pushToRepository(env.DEPLOY_REPO, env.DEPLOY_BRANCH, 'git-credentials')
                }
            }
        }
    }

    post {
        always {
            script {
                if (env.HAS_CHANGES == 'false') {
                    currentBuild.result = 'NOT_BUILT'
                }
            }
        }

        success {
            script {
                if (env.HAS_CHANGES == 'true') {
                    def emailHandler = load("${WORKSPACE}/jenkins/tony/scripts/email-handler.groovy")
                    def testRunner = load("${WORKSPACE}/jenkins/tony/scripts/test-runner.groovy")
                    
                    def testOutput = testRunner.getTestOutput('jest-results.log', 500)
                    def unitTestOutput = testRunner.getTestOutput('unit-test-results.log', 500)
                    
                    emailHandler.sendSuccessEmail(
                        env.EMAIL_RECIPIENT,
                        env.SOURCE_BRANCH,
                        env.SOURCE_REPO,
                        testOutput,
                        unitTestOutput
                    )
                }
            }
        }

        failure {
            script {
                if (env.HAS_CHANGES == 'true') {
                    def emailHandler = load("${WORKSPACE}/jenkins/tony/scripts/email-handler.groovy")
                    def testRunner = load("${WORKSPACE}/jenkins/tony/scripts/test-runner.groovy")
                    
                    def testOutput = testRunner.getTestOutput('jest-results.log', 1000)
                    def unitTestOutput = testRunner.getTestOutput('unit-test-results.log', 1000)
                    
                    emailHandler.sendFailureEmail(
                        env.EMAIL_RECIPIENT,
                        env.SOURCE_BRANCH,
                        env.SOURCE_REPO,
                        testOutput,
                        unitTestOutput
                    )
                }
            }
        }

        unstable {
            script {
                if (env.HAS_CHANGES == 'true') {
                    def emailHandler = load("${WORKSPACE}/jenkins/tony/scripts/email-handler.groovy")
                    emailHandler.sendUnstableEmail(
                        env.EMAIL_RECIPIENT,
                        env.SOURCE_BRANCH,
                        env.SOURCE_REPO
                    )
                }
            }
        }
    }
}
